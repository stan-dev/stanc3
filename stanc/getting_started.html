<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>getting_started (stanc.getting_started)</title><meta charset="utf-8"/><link rel="stylesheet" href="../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../';
let search_urls = ['db.js','../sherlodoc.js'];
</script><script src="../odoc.support/odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> â€“ <a href="../index.html">Index</a> &#x00BB; <a href="index.html">stanc</a> &#x00BB; getting_started</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1 id="getting-development-on-stanc3-up-and-running-locally"><a href="#getting-development-on-stanc3-up-and-running-locally" class="anchor"></a>Getting development on stanc3 up and running locally</h1></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#setup">Setup</a><ul><li><a href="#using-opam-and-dune">Using Opam and Dune</a></li><li><a href="#windows">Windows development</a></li></ul></li><li><a href="#development">Development</a><ul><li><a href="#useful-commands">Useful commands</a><ul><li><a href="#testing">Testing</a><ul><li><a href="#test-coverage">Test coverage</a></li></ul></li><li><a href="#code-formatting">Code formatting</a></li><li><a href="#updating-the-parser-error-messages">Updating the parser error messages</a></li><li><a href="#building-these-docs">Building these docs</a></li></ul></li><li><a href="#cmdstan">Developing with stanc3 and CmdStan</a></li><li><a href="#editors">Editor advice</a><ul><li><a href="#setting-up-vscode">Setting up VSCode</a></li><li><a href="#setting-up-emacs">Setting up Emacs</a></li></ul></li><li><a href="#finding-your-way-around-the-code">Finding your way around the code</a></li><li><a href="#advanced-development">Advanced development</a><ul><li><a href="#fuzzing">Fuzzing</a></li><li><a href="#profiling">Profiling</a></li></ul></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="setup"><a href="#setup" class="anchor"></a>Setup</h2><h3 id="using-opam-and-dune"><a href="#using-opam-and-dune" class="anchor"></a>Using Opam and Dune</h3><p>The recommended way to develop stanc3 is using <code>opam</code> and <code>dune</code> on a Unix-like system (MacOS or Linux). See <a href="#windows" title="windows">Windows development</a> for tips on developing on Windows.</p><p>This requires you have <code>make</code>, <code>git</code>, <code>curl</code>, and <code>m4</code> installed via apt, homebrew, or your system's package manager.</p><ol><li>Download the repository (or your fork of it) from Github</li><li><p>Install the necessary <a href="dependencies.html"><code>dependencies</code></a> by running</p><p><code>cd scripts; bash -x ./setup_dev_env.sh</code>.</p><p>If you already have opam installed, you can instead run</p><p><code>opam update; opam install --deps-only --with-test .</code></p><p>If you wish to <em>install</em> stanc on your system, you can run the above <code>opam</code> command without <code>--deps-only</code>.</p></li><li>You can now build a stanc binary by running <code>make</code>. If this succeeds, you have the required software.</li></ol><h3 id="windows"><a href="#windows" class="anchor"></a>Windows development</h3><p>We recommend using <a href="https://docs.microsoft.com/en-us/windows/wsl/install">Windows Subsystem for Linux (WSL)</a> for development on Windows. While this will not produce native-Windows binaries by default (though they can be <a href="dependencies.html#xcomp" title="xcomp">cross-compiled</a>), it is far easier to use and set up than the other options for Windows development.</p><p>Once you have installed and configured WSL, you can proceed through the steps above through the WSL shell.</p><h2 id="development"><a href="#development" class="anchor"></a>Development</h2><h3 id="useful-commands"><a href="#useful-commands" class="anchor"></a>Useful commands</h3><h4 id="testing"><a href="#testing" class="anchor"></a>Testing</h4><p>Once you have the necessary software, you can make your edits to the source files in <code>src/</code> and tests in <code>test/</code>. Running the command <code>dune runtest</code> (or <code>make test</code>) will show any test output which is different from the expected output. In our continuous integration, this results in test failures. If you are knowingly changing the output, and the differences highlighted by <code>dune runtest</code> look correct, you can run <code>dune promote</code> to change the expected output to match your current tests.</p><h5 id="test-coverage"><a href="#test-coverage" class="anchor"></a>Test coverage</h5><p>We have support for computing test coverage using the <a href="https://github.com/aantron/bisect_ppx">bisect_ppx</a> library. To generate a coverage report, run <code>make testcoverage</code>. This will print a summary of the coverage to the terminal, and generate a detailed HTML report in the <code>_coverage</code> directory. This report can be opened in a web browser.</p><p>Code coverage of the master branch is available on <a href="https://app.codecov.io/gh/stan-dev/stanc3">codecov.io</a>.</p><h4 id="code-formatting"><a href="#code-formatting" class="anchor"></a>Code formatting</h4><p>We recommend setting up your editor to use OCamlformat automatically. This will differ by editor, but is possible in most popular editors such as Emacs, VSCode, etc. See <a href="#editors" title="editors">Editor advice</a> for more specific tips.</p><p>If you would like to manually run the auto-formatter on all OCaml code in the repository, run <code>make format</code>. Similar to the above, you will need to run <code>dune promote</code> to accept these changes into the code.</p><p>If you would like to run the formatter before each commit (recommended), run</p><p><code>scripts/hooks/install_hooks.sh</code></p><p>Note: <code>ocamlformat</code> does not support <code>.mly</code> or <code>.mll</code> files used in the frontend.</p><h4 id="updating-the-parser-error-messages"><a href="#updating-the-parser-error-messages" class="anchor"></a>Updating the parser error messages</h4><p>If the parser has been edited, the building the compiler will halt to add any new error states to the <code>parser.messages</code> file. These will say</p><p><code>&lt;YOUR SYNTAX ERROR MESSAGE HERE&gt;</code></p><p>See <a href="parser_messages.html" title="parser_messages">adding or changing the syntax error messages</a> for more information.</p><h4 id="building-these-docs"><a href="#building-these-docs" class="anchor"></a>Building these docs</h4><p>Docs can be built with <code>make doc</code>. This will generate a <code>_build/default/_doc/_html/index.html</code> file which can be opened in a web browser.</p><h3 id="cmdstan"><a href="#cmdstan" class="anchor"></a>Developing with stanc3 and CmdStan</h3><p>In order to use the locally built development version of stanc3 with CmdStan, you need to set the <code>STANC3</code> makefile variable in the make/local file in CmdStan. Example:</p><p><code>STANC3=relative/or/absolute/path/to/the/cloned/stanc3/folder</code></p><p>This will automatically rebuild the stanc3 binary used in CmdStan if a change was made to the stanc3 source files.</p><h3 id="editors"><a href="#editors" class="anchor"></a>Editor advice</h3><p>For working on this project, we recommend using either VSCode or Emacs as an editor, due to their good OCaml support through <a href="https://github.com/ocaml/merlin">Merlin</a>: syntax highlighting, auto-completion, type inference, automatic case splitting, and more. For people who prefer a GUI and have not memorized all Emacs or Vim keystrokes, VSCode might have the less steep learning curve. Anything with Merlin support is fine.</p><h4 id="setting-up-vscode"><a href="#setting-up-vscode" class="anchor"></a>Setting up VSCode</h4><p>Install instructions for VSCode can be found <a href="https://code.visualstudio.com/docs/setup/setup-overview">here</a>.</p><p><b>For Windows users</b>: We recommend using <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl">Remote - WSL</a> to program within WSL from a native Windows installation of VSCode. This extension allows you to connect to the WSL instance as if it is a remote machine, removing the need for an X11 server or other method of running a Linux GUI app directly.</p><p>Once in VSCode (on any platform), simply install the <a href="https://github.com/reasonml-editor/vscode-reasonml">OCaml extension</a> and you should be ready to go.</p><h4 id="setting-up-emacs"><a href="#setting-up-emacs" class="anchor"></a>Setting up Emacs</h4><p>The best way to edit OCaml in Emacs is through <a href="https://github.com/ocaml/tuareg">Tuareg mode</a>.</p><p>To get full Merlin support, you will need to run <code>opam user-setup install</code> after installing Merlin in our <a href="dependencies.html#dev" title="dev">dev dependencies</a>.</p><p>If you use <a href="https://github.com/jwiegley/use-package"><code>use-package.el</code></a>, this snippet should set up Tuareg+Merlin+OCamlformat</p><pre class="language-ocaml"><code>(use-package tuareg
  :config
  (electric-indent-mode 0)
  (face-spec-set
   'tuareg-font-lock-constructor-face
   '((((class color) (background light)) (:foreground &quot;SaddleBrown&quot;))
     (((class color) (background dark)) (:foreground &quot;burlywood1&quot;))))
  (add-hook 'tuareg-mode-hook
            (lambda ()
              (prettify-symbols-mode 0))))
(use-package merlin
  :config
  (add-hook 'tuareg-mode-hook 'merlin-mode t)
  (with-eval-after-load 'company
    (add-to-list 'company-backends 'merlin-company-backend)))

(require 'ocamlformat)
(add-hook 'tuareg-mode-hook
          (lambda ()
            (define-key tuareg-mode-map (kbd &quot;C-M-&lt;tab&gt;&quot;) #'ocamlformat)
            (add-hook 'before-save-hook #'ocamlformat-before-save)))</code></pre><h3 id="finding-your-way-around-the-code"><a href="#finding-your-way-around-the-code" class="anchor"></a>Finding your way around the code</h3><p>Even to an experienced OCaml developer, there are certain practices in the stanc3 codebase which might be unfamiliar. We have tried to document those on our <a href="core_ideas.html" title="core_ideas">Core ideas</a> page.</p><h3 id="advanced-development"><a href="#advanced-development" class="anchor"></a>Advanced development</h3><h4 id="fuzzing"><a href="#fuzzing" class="anchor"></a>Fuzzing</h4><p>OCaml has <a href="https://v2.ocaml.org/manual/afl-fuzz.html">support</a> for building binaries instrumented for use with the<a href="https://aflplus.plus/">AFL++</a> fuzzing tool. This requires a new opam switch which includes the <code>ocaml-option-afl</code> base package.</p><pre class="language-ocaml"><code>opam switch create &quot;stanc-fuzz&quot; --packages &quot;ocaml-option-afl,ocaml.4.14.1&quot;
eval $(opam env)
./scripts/install_build_deps.sh</code></pre><p>After this, the normal build process will produce a binary ready for fuzzing.</p><h4 id="profiling"><a href="#profiling" class="anchor"></a>Profiling</h4><p>Profiling support is not directly provided in the stanc3 repository, but you can use the <a href="https://github.com/LexiFi/landmarks">Landmarks</a> library to profile the code.</p><p>This requires editing the <code>dune</code> files in the <code>src/</code> directory to include the landmarks library, similar to how the <code>bisect_ppx</code> library is instrumented by default.</p><pre class="language-ocaml"><code>(instrumentation
  (backend landmarks --auto))</code></pre><p>You can then build a profiled version of the code by running <code>dune build src/stanc/stanc.exe --instrument-with landmarks --force</code>.</p><p>To configure the profiler at runtime, consult the Landmarks documentation. A good starting command is</p><pre class="language-ocaml"><code>OCAML_LANDMARKS=&quot;on,output=prof.txt&quot; stanc.exe mymodel.stan</code></pre></div></body></html>
