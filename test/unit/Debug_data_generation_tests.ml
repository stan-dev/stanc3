open Analysis_and_optimization
open Core
open Frontend
open Debug_data_generation

let print_data_prog ast =
  gen_values_json (Ast_to_Mir.gather_declarations ast.Ast.datablock)
  |> Result.ok |> Option.value_exn

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|       data {
                  int<lower=7> K;
                  int<lower=1> D;
                  int<lower=0> N;
                  array[N,D] int<lower=0,upper=1> y;
                  array[N] vector[K] x;
                    }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "K": 11,
      "D": 5,
      "N": 2,
      "y": [ [ 0, 0, 0, 0, 1 ], [ 1, 0, 1, 1, 0 ] ],
      "x": [
        [
          3.0259842899874729, 4.8044739422846732, 3.7211525740708074,
          6.8622661400288045, 2.4223302835220188, 5.6956117034833795,
          2.3891242248965958, 4.2547058713364931, 3.75513863417878,
          3.5763093603544593, 2.7518878100953712
        ],
        [
          3.38547409994535, 3.1776483198403431, 5.09487721830358,
          2.8530432935674259, 5.8432069990901141, 3.5554516422725282,
          6.0928627865566289, 3.1323519064604128, 4.8077618882716529,
          4.8844183964086758, 2.0070633491611534
        ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|       data {
                    array[3, 4] int x;
                    array[5, 2, 4] int y;
                    matrix[3, 4] z;
                    vector[3] w;
                    array[4] vector[3] p;
                }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "x": [ [ 3, 5, 6, 3 ], [ 5, 2, 2, 2 ], [ 3, 4, 6, 6 ] ],
      "y": [
        [ [ 5, 4, 2, 4 ], [ 6, 2, 5, 3 ] ],
        [ [ 5, 5, 5, 3 ], [ 4, 4, 4, 4 ] ],
        [ [ 2, 4, 6, 2 ], [ 5, 3, 2, 4 ] ],
        [ [ 5, 5, 6, 3 ], [ 4, 2, 3, 2 ] ],
        [ [ 2, 6, 3, 6 ], [ 5, 4, 2, 6 ] ]
      ],
      "z": [
        [
          5.9462114906286692, 3.3013688638546972, 2.1687926346256448,
          6.1872666657611122
        ],
        [
          6.1040356861693361, 5.1936294581652929, 4.7244839885583918,
          2.8233098893574877
        ],
        [
          4.5289845760404219, 5.9619040126222966, 4.9264939695638361,
          3.1492152528102997
        ]
      ],
      "w": [ 6.5130635454759123, 4.0972021454203746, 5.5262544534621307 ],
      "p": [
        [ 6.39197802543506, 3.3902159167699923, 5.9163868936974993 ],
        [ 4.5262143612916308, 2.0877582633307856, 4.933785955218279 ],
        [ 4.85535249062692, 2.3932679521201239, 6.2643191502226356 ],
        [ 4.6443235535714438, 4.9826149801399771, 3.1718660259212861 ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|       data {
                  int<lower=2, upper=4> K;
                  int<lower=K, upper=K> D;
                  vector[K - 1] x;
                  vector[K * D] y;
                  vector[K ? D : K] z;
                  array[(D + 2 == K) + 3] vector[K ? D : K] w;
                }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "K": 2,
      "D": 2,
      "x": [ 5.9127523362344 ],
      "y": [
        2.443508089469689, 4.7700876114666935, 4.4357759092714995,
        5.8604379405430693
      ],
      "z": [ 2.139006660326443, 5.4118457736322156 ],
      "w": [
        [ 3.9860556058988044, 5.2125850408854451 ],
        [ 5.5174999051660887, 5.8190370017032622 ],
        [ 3.4526809359041621, 3.2704887966480278 ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
        data {
          corr_matrix[5] d;
          cov_matrix[4] e;
          cholesky_factor_cov[4] f;
          cholesky_factor_corr[4] g;
          unit_vector[4] h;
          simplex[12] i;
          ordered[2] j;
          positive_ordered[4] k;
          cholesky_factor_cov[5, 4] l;
        }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "d": [
        [
          1.0, 0.17913555949357865, 0.026971002224301811, 0.6586593126893403,
          0.590754158087648
        ],
        [
          0.17913555949357865, 0.99999999999999967, 0.65611253748828746,
          0.36447674618838843, 0.36595715567552811
        ],
        [
          0.026971002224301811, 0.65611253748828746, 1.0000000000000004,
          0.34774493699442366, 0.51132865091605972
        ],
        [
          0.6586593126893403, 0.36447674618838843, 0.34774493699442366, 1.0,
          0.86508304296658367
        ],
        [
          0.590754158087648, 0.36595715567552811, 0.51132865091605972,
          0.86508304296658367, 1.0000000000000002
        ]
      ],
      "e": [
        [
          5.0135444030224559, 6.2464431209274842, 4.8691680287237444,
          5.5564790474631476
        ],
        [
          6.2464431209274842, 8.14928162206261, 5.5100515956388305,
          7.5409467872247671
        ],
        [
          4.8691680287237444, 5.5100515956388305, 5.9552493949393215,
          5.0114616832215937
        ],
        [
          5.5564790474631476, 7.5409467872247671, 5.0114616832215937,
          8.0919626756519
        ]
      ],
      "f": [
        [ 1.674906666304445, 0.0, 0.0, 0.0 ],
        [ 0.067517053850257872, 1.6416142744677344, 0.0, 0.0 ],
        [ 1.5784845962514678, 0.520547545541879, 1.2774517832661172, 0.0 ],
        [
          1.8052254181903651, 0.83888085816814983, 1.4105017813848524,
          1.0897935954233566
        ]
      ],
      "g": [
        [ 1.0, 0.0, 0.0, 0.0 ],
        [ 0.14710364114405425, 0.98912108397413168, 0.0, 0.0 ],
        [ 0.5792057324268951, 0.56372092440107013, 0.588845853272507, 0.0 ],
        [
          0.81483921285902872, 0.52560142231622964, 0.01825888916373649,
          0.24381717538545453
        ]
      ],
      "h": [
        0.030739844749625496, 0.70355661363655919, 0.67687383572538984,
        0.21425443720825094
      ],
      "i": [
        0.02382328251605265, 0.12788636984307886, 0.12040365789259891,
        0.086617515541315457, 0.0594384860189326, 0.069822917617405819,
        0.025840421010612263, 0.12500351033605753, 0.061107976942362384,
        0.1605082457790524, 0.030862453612948992, 0.10868516288958241
      ],
      "j": [ 0.14197365864238409, 0.58843818154692507 ],
      "k": [
        0.23336708361398012, 1.0950644958546272, 1.689972306936034,
        1.8586389854047796
      ],
      "l": [
        [ 1.1823752199822606, 0.0, 0.0, 0.0 ],
        [ 1.0072567866506608, 0.96724039614672608, 0.0, 0.0 ],
        [ 1.002399736756995, 1.0716502816324474, 0.38820761415798027, 0.0 ],
        [
          0.518734723472252, 1.5548914710988877, 0.94824417203495781,
          1.6157787777180612
        ],
        [
          0.31772383419905603, 1.3761950024538481, 1.7454015504479596,
          0.59078975072929385
        ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
        data {
          int<lower=0> N;
          int<lower=0> M;
          int<lower=0, upper=N * M> K;
          array[N] int<upper=N> d_int_1d_ar;
          array[N, M, K] int<upper=N> d_int_3d_ar;
          real<lower=-2.0, upper=2.0> J;
          array[N] real d_real_1d_ar;
          array[N, M, K] real d_real_3d_ar;
          vector[N] d_vec;
          array[N] vector[N] d_1d_vec;
          array[N, M, K] vector[N] d_3d_vec;
          row_vector[N] d_row_vec;
          array[N] row_vector[N] d_1d_row_vec;
          array[N, M, K] row_vector[N] d_3d_row_vec;
          array[4, 5] matrix<lower=0, upper=1>[2, 3] d_ar_mat;
          simplex[N] d_simplex;
          array[N] simplex[N] d_1d_simplex;
          array[N, M, K] simplex[N] d_3d_simplex;
          cholesky_factor_cov[5, 4] d_cfcov_54;
          cholesky_factor_cov[3] d_cfcov_33;
          array[K] cholesky_factor_cov[3] d_cfcov_33_ar;
        }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "N": 4,
      "M": 1,
      "K": 2,
      "d_int_1d_ar": [ 1, 4, 4, 3 ],
      "d_int_3d_ar": [ [ [ 3, 1 ] ], [ [ 1, 1 ] ], [ [ 3, 1 ] ], [ [ 2, 2 ] ] ],
      "J": 0.30753471712694047,
      "d_real_1d_ar": [
        3.5554516422725282, 6.0928627865566289, 3.1323519064604128,
        4.8077618882716529
      ],
      "d_real_3d_ar": [
        [ [ 3.75513863417878, 3.5763093603544593 ] ],
        [ [ 2.7518878100953712, 3.38547409994535 ] ],
        [ [ 3.1776483198403431, 5.09487721830358 ] ],
        [ [ 2.8530432935674259, 5.8432069990901141 ] ]
      ],
      "d_vec": [
        2.4223302835220188, 5.6956117034833795, 2.3891242248965958,
        4.2547058713364931
      ],
      "d_1d_vec": [
        [
          5.1472133818056456, 3.920386318607493, 5.7485514338558641,
          5.8373862870981625
        ],
        [
          4.5721504447691075, 3.3807052645713709, 4.2687352254093032,
          5.4285544121578608
        ],
        [
          6.5905333177414578, 4.3334827840545307, 4.3159469221988545,
          3.5455097509193272
        ],
        [
          3.0259842899874729, 4.8044739422846732, 3.7211525740708074,
          6.8622661400288045
        ]
      ],
      "d_3d_vec": [
        [
          [
            [
              2.1061776972454851, 2.7767613539235096, 2.9119861534268905,
              6.9352615407221574
            ],
            [
              4.7803263694348956, 2.8740585350459709, 5.7717554939668121,
              5.3866817956353819
            ]
          ]
        ],
        [
          [
            [
              6.7106586513631941, 3.0656647167671833, 3.8520414429348753,
              4.8049850377836769
            ],
            [
              6.6245348441310892, 5.8241254741356761, 6.3013867873108218,
              6.9886582986551851
            ]
          ]
        ],
        [
          [
            [
              4.612385710894424, 3.7104738812888591, 6.2937466265308792,
              5.168647023282924
            ],
            [
              2.9985598981289341, 6.2264437153156722, 3.7284470866678419,
              3.1082700780478847
            ]
          ]
        ],
        [
          [
            [
              4.7398702855536587, 4.7816570437097479, 3.4486928194698576,
              5.2302066164690242
            ],
            [
              4.4781826349388094, 2.6579636530788755, 6.0652227552345641,
              6.1563526722724209
            ]
          ]
        ]
      ],
      "d_row_vec": [
        5.3903842348773967, 5.012670451747737, 6.291694978288791,
        6.9187038989428764
      ],
      "d_1d_row_vec": [
        [
          6.1455407452697246, 6.6126927915758751, 5.8060956538083248,
          6.3042718458189269
        ],
        [
          6.2924928612786477, 3.060561254428988, 5.1529199364040856,
          2.2861983276563733
        ],
        [
          2.97605035312192, 3.3714433752902195, 2.3830788693271843,
          2.7494073290104142
        ],
        [
          4.1954635647181409, 6.30643929418095, 2.2253444330004433,
          5.3366483477465234
        ]
      ],
      "d_3d_row_vec": [
        [
          [
            [
              2.4760749037179881, 3.2003280349704109, 5.01692379768198,
              2.8173362420472574
            ],
            [
              2.2556464495684314, 2.3303037261344128, 6.0373221989595507,
              5.9979184026441
            ]
          ]
        ],
        [
          [
            [
              3.363490770850778, 3.4000402324879637, 4.2153834746321728,
              6.5483198265385925
            ],
            [
              2.9614907778232995, 3.6053695769530938, 3.8461789352677007,
              5.62166289171807
            ]
          ]
        ],
        [
          [
            [
              4.3918561872650166, 4.7652361802568581, 2.8031759431719037,
              5.3631561168422914
            ],
            [
              6.3229591778233658, 5.0450818132335833, 6.4795914936361605,
              4.5133374677015876
            ]
          ]
        ],
        [
          [
            [
              2.3959433290276242, 6.6693088847337485, 3.8641481808405214,
              2.3554792997360807
            ],
            [
              6.6533439111346375, 3.2375464263032057, 3.4056274951524692,
              6.9239685672149225
            ]
          ]
        ]
      ],
      "d_ar_mat": [
        [
          [
            [ 0.25074317582034983, 0.96650822742448417, 0.77409573117271635 ],
            [ 0.782733827857173, 0.35156778745257938, 0.53509952471993039 ]
          ],
          [
            [ 0.51545438801356969, 0.57472731030012292, 0.035390661103131479 ],
            [ 0.22879874962735577, 0.49592652058090025, 0.27425393555170147 ]
          ],
          [
            [ 0.44037886661854081, 0.031720916421459459, 0.10281368249151868 ],
            [ 0.63349500968944972, 0.28877184127756761, 0.30291758701746474 ]
          ],
          [
            [ 0.32682285614457568, 0.60661865673084592, 0.20026876849140895 ],
            [ 0.78682038598345694, 0.98124621604078432, 0.0847204689345546 ]
          ],
          [
            [ 0.75966140765543622, 0.24886011486679821, 0.99559749504154482 ],
            [ 0.63870253159828838, 0.45031404740947578, 0.53074001519086567 ]
          ]
        ],
        [
          [
            [ 0.65277664591658191, 0.37298795957348463, 0.97523511678154462 ],
            [ 0.71388313699139194, 0.95364545445199478, 0.67728071813902246 ]
          ],
          [
            [ 0.5246816487285596, 0.14642724914551755, 0.7696133962718873 ],
            [ 0.0049306275737114793, 0.55608764957177048, 0.27404919483956069 ]
          ],
          [
            [ 0.75017326959084552, 0.44136096730409269, 0.36134599496475905 ],
            [ 0.91404352103547126, 0.74346172594283932, 0.78765655320918859 ]
          ],
          [
            [ 0.16997796995052628, 0.39870528719229742, 0.12262503252828519 ],
            [ 0.056037765133922904, 0.3981767969958957, 0.77742125062788447 ]
          ],
          [
            [ 0.24076506553097504, 0.6104480322098903, 0.6285469723315833 ],
            [ 0.19769692857695376, 0.76822504358537724, 0.4734482207817669 ]
          ]
        ],
        [
          [
            [ 0.43888289523157953, 0.34550401708042644, 0.0604068557765696 ],
            [ 0.58440801105563933, 0.78694280786743853, 0.756533312848852 ]
          ],
          [
            [ 0.23607378115681729, 0.29397936820065595, 0.69327751590557807 ],
            [ 0.58718078599130319, 0.90652826242505091, 0.50846545535005838 ]
          ],
          [
            [ 0.44248593604378172, 0.74101206092206673, 0.92364994546507861 ],
            [ 0.81617258796920333, 0.38294015435531764, 0.92747716302086458 ]
          ],
          [
            [ 0.029844293120737046, 0.24872415367119882, 0.24422731481893661 ],
            [ 0.57729230109565721, 0.56127637060771207, 0.77940988508090725 ]
          ],
          [
            [ 0.76771867799966631, 0.20988164410224353, 0.43635426425803958 ],
            [ 0.65496304851827547, 0.88492933895221937, 0.80939122139712227 ]
          ]
        ],
        [
          [
            [ 0.36703815100726328, 0.28550210433252582, 0.52645996317153809 ],
            [ 0.16615016415138223, 0.57425351142699055, 0.71107200719215058 ]
          ],
          [
            [ 0.012098378667933639, 0.94296817377357189, 0.48442410486059878 ],
            [ 0.34448525057839052, 0.87442247499684322, 0.12667142083648314 ]
          ],
          [
            [ 0.56161831665357331, 0.33638062440560507, 0.31064493884685496 ],
            [ 0.826883422472149, 0.43479325374707906, 0.185751763505009 ]
          ],
          [
            [ 0.20654300309559484, 0.82329355565865792, 0.77841502035222 ],
            [ 0.088118595220066279, 0.94806641559253446, 0.22484691579637417 ]
          ],
          [
            [ 0.45284817981995229, 0.12259497667589278, 0.34122209837897 ],
            [ 0.57810863649342215, 0.60946173444175478, 0.11157866702557391 ]
          ]
        ]
      ],
      "d_simplex": [
        0.24773571205781902, 0.44445910885261464, 0.015503266487225923,
        0.29230191260234034
      ],
      "d_1d_simplex": [
        [
          0.091621621083523119, 0.4236655288511868, 0.47633644016297549,
          0.0083764099023145473
        ],
        [
          0.27530315967436592, 0.18410987609060314, 0.29711090524593503,
          0.24347605898909577
        ],
        [
          0.26733312733079323, 0.083631672335200552, 0.35939280112435423,
          0.289642399209652
        ],
        [
          0.23219517162266085, 0.38235474052131257, 0.38386522113646371,
          0.0015848667195628907
        ]
      ],
      "d_3d_simplex": [
        [
          [
            [
              0.45039153533868842, 0.2222663322432579, 0.10074457405755548,
              0.22659755836049825
            ],
            [
              0.048231802228809295, 0.6215698125212189, 0.044536017641180994,
              0.28566236760879088
            ]
          ]
        ],
        [
          [
            [
              0.095862239276157515, 0.339522749940362, 0.11924744029237835,
              0.44536757049110209
            ],
            [
              0.053141676871924608, 0.1332973646295029, 0.47491104786598032,
              0.33864991063259214
            ]
          ]
        ],
        [
          [
            [
              0.27862452824652151, 0.28345218229461105, 0.30537636250659217,
              0.13254692695227524
            ],
            [
              0.11944879907202785, 0.27159866285769568, 0.11493047381593251,
              0.494022064254344
            ]
          ]
        ],
        [
          [
            [
              0.11369412516970719, 0.24297637995485891, 0.53274865335744181,
              0.11058084151799205
            ],
            [
              0.40966432652607954, 0.14399953005237986, 0.435790007800903,
              0.010546135620637692
            ]
          ]
        ]
      ],
      "d_cfcov_54": [
        [ 0.96015248761924665, 0.0, 0.0, 0.0 ],
        [ 1.206951975838213, 0.057745837429325611, 0.0, 0.0 ],
        [ 0.64615966362018706, 1.7658718337239145, 1.2728984741334233, 0.0 ],
        [
          1.4052400968848324, 0.0014517444519305169, 1.3630225135306777,
          0.97036015486893268
        ],
        [
          0.58669630771338854, 1.4639841319046965, 1.4031723635116757,
          1.2674285838902879
        ]
      ],
      "d_cfcov_33": [
        [ 1.5116510896504936, 0.0, 0.0 ],
        [ 1.1310316074515245, 0.67520095375755829, 0.0 ],
        [ 0.53901989127004646, 0.91346044695819373, 0.12394569082932359 ]
      ],
      "d_cfcov_33_ar": [
        [
          [ 1.3993669493677277, 0.0, 0.0 ],
          [ 0.52926034413316614, 0.53393693160514344, 0.0 ],
          [ 0.7444958876777964, 0.75658561470098373, 0.17907864777587915 ]
        ],
        [
          [ 0.74453643252253743, 0.0, 0.0 ],
          [ 0.16739643738973, 1.0799993395387184, 0.0 ],
          [ 1.611464548520688, 1.0170314890791112, 0.227409381334204 ]
        ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
        data {
          vector<upper=10>[5] x_vect;
          vector<lower=20.0>[5] x_vect_up;

          vector<lower=x_vect>[5] y_lower_vect;
          vector<upper=x_vect_up>[5] y_upper_vect;
          vector<lower=x_vect, upper=20>[5] y_lower_vect_upper_int;
          vector<lower=x_vect, upper=20.0>[5] y_lower_vect_upper_float;
          vector<lower=1, upper=x_vect_up>[5] y_lower_int_upper_vect;
          vector<lower=1.3, upper=x_vect_up>[5] y_lower_float_upper_vect;
          vector<lower=[1,2,3,4,5]'>[5] y_given_bound;
          vector<lower=0.5, upper=[1,2,3,4,5]'>[5] y_given_bound_and_scalar;
          vector<lower=[1,2,3,4,5]',upper=[2,3,4,5,6]'>[5] y_lu_given_bound;
          vector<lower=x_vect,upper=x_vect_up>[5] y_lu_vector_bound;
          vector<lower=[1,2,3,4,5]',upper=x_vect_up>[5] y_lu_vector_bound_mixed;

          row_vector<upper=10>[5] x_row_vect;
          row_vector<lower=20.0>[5] x_row_vect_up;

          row_vector<lower=x_row_vect>[5] y_row_lower_vect;
          row_vector<upper=x_row_vect_up>[5] y_row_upper_vect;
          row_vector<lower=x_row_vect, upper=20>[5] y_row_lower_vect_upper_int;
          row_vector<lower=x_row_vect, upper=20.0>[5] y_row_lower_vect_upper_float;
          row_vector<lower=1, upper=x_row_vect_up>[5] y_row_lower_int_upper_vect;
          row_vector<lower=1.3, upper=x_row_vect_up>[5] y_row_lower_float_upper_vect;
          row_vector<lower=[1,2,3,4,5]>[5] y_row_given_bound;
          row_vector<lower=0.5, upper=[1,2,3,4,5]>[5] y_row_given_bound_and_scalar;
          row_vector<lower=[1,2,3,4,5],upper=[2,3,4,5,6]>[5] y_row_lu_given_bound;
          row_vector<lower=x_row_vect,upper=x_row_vect_up>[5] y_row_lu_vector_bound;
          row_vector<lower=[1,2,3,4,5],upper=x_row_vect_up>[5] y_row_lu_vector_bound_mixed;

          matrix<upper=2.0>[2,2] upper_matrix;
          matrix<lower=upper_matrix, upper=5>[2,2] lower_upper_matrix;
        }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "x_vect": [
        7.7700876114666935, 7.4357759092714995, 8.8604379405430684,
        8.9127523362344, 8.17675706158378
      ],
      "x_vect_up": [
        21.452680935904162, 21.270488796648028, 20.139006660326444,
        23.411845773632216, 20.443508089469688
      ],
      "y_lower_vect": [
        11.589124613169954, 10.953275814437587, 12.073022981428513,
        10.898807942133203, 12.61408849858017
      ],
      "y_upper_vect": [
        21.428586152291523, 18.450567488616393, 18.794176100187507,
        21.187116438465598, 18.879499921130247
      ],
      "y_lower_vect_upper_int": [
        19.687783755474225, 7.4434574149376118, 11.743335531145213,
        17.692455251117078, 17.559605838143344
      ],
      "y_lower_vect_upper_float": [
        18.202407421532914, 10.323575502229863, 15.380410178659632,
        17.698074537836426, 14.156916867590471
      ],
      "y_lower_int_upper_vect": [
        4.3677788956806509, 12.045324433343962, 13.224579094088055,
        19.395802969582004, 17.283030657698593
      ],
      "y_lower_float_upper_vect": [
        1.9803248219882534, 6.4977944631833617, 16.168540911002047,
        16.89439892670768, 9.3295612472216263
      ],
      "y_given_bound": [
        5.5130635454759123, 3.1718660259212861, 5.9826149801399771,
        6.6443235535714438, 9.2643191502226365
      ],
      "y_given_bound_and_scalar": [
        0.53932679521201243, 1.3566057471880761, 1.9668929776091395,
        0.56143078433155, 2.7735929251624674
      ],
      "y_lu_given_bound": [
        1.7832773787394998, 2.2780431833539985, 3.8783956050870119,
        4.9130224936024565, 5.0398918426211452
      ],
      "y_lu_vector_bound": [
        16.546965695581438, 9.9557843010534679, 19.544901557104815,
        14.142011196093232, 17.226852224549425
      ],
      "y_lu_vector_bound_mixed": [
        4.1192574051334949, 9.9413092597402226, 9.0124956137254735,
        13.923707181137232, 15.97455772545818
      ],
      "x_row_vect": [
        5.8433333923437276, 8.652059200946546, 7.2323226145227055,
        5.7030285976564095, 8.7739457268143823
      ],
      "x_row_vect_up": [
        20.97051903539495, 24.039446944295154, 21.1668354180699,
        24.308487061203234, 22.974539055407035
      ],
      "y_row_lower_vect": [
        8.2614343827105419, 11.607997250902198, 9.7504645811493571,
        8.3821543017375273, 11.279945068706869
      ],
      "y_row_upper_vect": [
        18.341129465482346, 22.926675622042374, 17.463672226750532,
        20.78546143802647, 22.338042931526935
      ],
      "y_row_lower_vect_upper_int": [
        15.584500310774644, 10.454814831416128, 18.407395147580274,
        13.48475835248918, 19.188631984144941
      ],
      "y_row_lower_vect_upper_float": [
        10.312115921477815, 11.584897198714282, 8.9687706370847948,
        7.1600723752754662, 13.406906212757406
      ],
      "y_row_lower_int_upper_vect": [
        16.341350585049092, 8.8005207521613862, 12.704762035960403,
        18.310843846478289, 11.155547774776919
      ],
      "y_row_lower_float_upper_vect": [
        8.7647400296376077, 6.5381488933455971, 2.7727504438567534,
        13.603106097269555, 15.583517863396999
      ],
      "y_row_given_bound": [
        3.2143199745222515, 6.9797912647977247, 3.2596240935523397,
        8.2664747241808634, 7.3847188135810784
      ],
      "y_row_given_bound_and_scalar": [
        0.77517233992425527, 0.96175052596406152, 1.3414558861225334,
        2.5377045634052005, 3.1145090637671253
      ],
      "y_row_lu_given_bound": [
        1.460096047520645, 2.5716485057703204, 3.397303849272042,
        4.074712205498912, 5.011746301377249
      ],
      "y_row_lu_vector_bound": [
        12.974674473085226, 12.936081769989599, 17.453189200688303,
        7.4846020162795686, 15.185916611195875
      ],
      "y_row_lu_vector_bound_mixed": [
        8.9421439572248431, 20.041492284281148, 8.4962429478965547,
        21.652351509700598, 15.694051898046979
      ],
      "upper_matrix": [
        [ 0.9099490693217076, -2.2004417397637552 ],
        [ -1.24265022191756, -0.56013390862919277 ]
      ],
      "lower_upper_matrix": [
        [ 1.4840814751890148, 4.1237181017541555 ],
        [ 0.98650648596859125, 1.3374480127938284 ]
      ]
    }
    |}]

let%expect_test "whole program data generation check" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
      data {
        int<lower = 0> K;                     // players
        int<lower = 0> N;                     // games
        array[N] int<lower=1, upper = K> player1;   // player 1 for game n
        array[N] int<lower=1, upper = K> player0;   // player 0 for game n
        array[N] int<lower = 0, upper = 1> y;       // winner for game n
      }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {| { "K": 4, "N": 1, "player1": [ 2 ], "player0": [ 3 ], "y": [ 1 ] } |}]

let%expect_test "Complex numbers program" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
      data {
        complex z;
        array[3] complex z_arr;
        complex_vector[2] zvec;
        complex_row_vector[3] zrowvec;
        complex_matrix[2,3] zmat;
      }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "z": [ 5.9127523362344, 5.17675706158378 ],
      "z_arr": [
        [ 2.139006660326443, 5.4118457736322156 ],
        [ 2.443508089469689, 4.7700876114666935 ],
        [ 4.4357759092714995, 5.8604379405430693 ]
      ],
      "zvec": [
        [ 5.5174999051660887, 5.8190370017032622 ],
        [ 3.4526809359041621, 3.2704887966480278 ]
      ],
      "zrowvec": [
        [ 5.6551694398610612, 4.180078691968367 ],
        [ 6.9759052163873587, 6.4373314369963888 ],
        [ 3.9860556058988044, 5.2125850408854451 ]
      ],
      "zmat": [
        [
          [ 4.5289845760404219, 5.9619040126222966 ],
          [ 4.9264939695638361, 3.1492152528102997 ],
          [ 6.2650836239217469, 5.9679675134106827 ]
        ],
        [
          [ 5.9593698910396657, 3.2939905425432361 ],
          [ 2.0030568961563575, 6.87235548603827 ],
          [ 5.4359918316605587, 4.7752706648333811 ]
        ]
      ]
    }
    |}]

let%expect_test "Tuples program" =
  let ast =
    Test_utils.typed_ast_of_string_exn
      {|
      data {
        tuple(real, int) d;
        tuple(array[2] real, int, matrix[3,3]) complicated;
        tuple(real, tuple(real, real)) n;
        array[3] tuple(real, array[4] tuple(int, int)) nested;
      }
      |}
  in
  let str = print_data_prog ast in
  print_string str;
  [%expect
    {|
    {
      "d": { "1": 5.17675706158378, "2": 4 },
      "complicated": {
        "1": [ 4.6764380781542858, 2.7175190177864881 ],
        "2": 5,
        "3": [
          [ 5.2125850408854451, 5.5174999051660887, 5.8190370017032622 ],
          [ 3.4526809359041621, 3.2704887966480278, 2.139006660326443 ],
          [ 5.4118457736322156, 2.443508089469689, 4.7700876114666935 ]
        ]
      },
      "n": {
        "1": 3.9860556058988044,
        "2": { "1": 6.4373314369963888, "2": 6.9759052163873587 }
      },
      "nested": [
        {
          "1": 3.1492152528102997,
          "2": [
            { "1": 6, "2": 4 },
            { "1": 3, "2": 4 },
            { "1": 5, "2": 5 },
            { "1": 5, "2": 6 }
          ]
        },
        {
          "1": 2.0030568961563575,
          "2": [
            { "1": 4, "2": 5 },
            { "1": 4, "2": 2 },
            { "1": 2, "2": 6 },
            { "1": 3, "2": 5 }
          ]
        },
        {
          "1": 4.180078691968367,
          "2": [
            { "1": 3, "2": 5 },
            { "1": 4, "2": 4 },
            { "1": 4, "2": 4 },
            { "1": 4, "2": 2 }
          ]
        }
      ]
    }
    |}]
